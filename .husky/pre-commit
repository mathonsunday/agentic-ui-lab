#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ” PRE-COMMIT CHECKS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Flag to track if any check failed
FAILED=0

# 1. Run lint-staged on staged files
echo "ğŸ“ Running lint-staged (ESLint + type-check on staged files)..."
npx lint-staged || FAILED=1

if [ $FAILED -eq 1 ]; then
  echo ""
  echo -e "${RED}âŒ Lint-staged check failed${NC}"
  echo "Fix issues and try again:"
  echo "  npm run lint -- --fix        # Auto-fix ESLint issues"
  echo "  npm run type-check           # Check TypeScript"
  echo ""
  exit 1
fi
echo -e "${GREEN}âœ… Lint-staged passed${NC}"
echo ""

# 2. Run full TypeScript type check (not just staged)
echo "ğŸ”¬ Full TypeScript type check..."
npm run type-check || FAILED=1

if [ $FAILED -eq 1 ]; then
  echo ""
  echo -e "${RED}âŒ Type check failed${NC}"
  echo "Fix type errors and try again:"
  echo "  npm run type-check           # See all type errors"
  echo ""
  exit 1
fi
echo -e "${GREEN}âœ… Type check passed${NC}"
echo ""

# 3. Check for unused exports (optional - can be slow)
echo "ğŸ’€ Scanning for unused exports (knip)..."
npm run dead-code || FAILED=1

if [ $FAILED -eq 1 ]; then
  echo ""
  echo -e "${YELLOW}âš ï¸  Dead code detected${NC}"
  echo "Review unused code:"
  echo "  npm run dead-code            # See all unused exports"
  echo "  npm run dead-code:fix        # Auto-fix simple cases"
  echo ""
  echo "Note: You can skip this check with: git commit --no-verify"
  echo ""
  exit 1
fi
echo -e "${GREEN}âœ… Dead code check passed${NC}"
echo ""

# 4. Run security scan
echo "ğŸ”’ Running security scan (Semgrep)..."
npm run security || FAILED=1

if [ $FAILED -eq 1 ]; then
  echo ""
  echo -e "${RED}âŒ Security scan failed${NC}"
  echo "Review security issues:"
  echo "  npm run security             # See security findings"
  echo ""
  exit 1
fi
echo -e "${GREEN}âœ… Security scan passed${NC}"
echo ""

# 5. Run critical tests only (if available)
echo "ğŸ§ª Running tests (critical path)..."
npm test -- --run || FAILED=1

if [ $FAILED -eq 1 ]; then
  echo ""
  echo -e "${RED}âŒ Tests failed${NC}"
  echo "Fix failing tests:"
  echo "  npm test                     # Run all tests"
  echo "  npm run test:ui              # Run tests with UI"
  echo ""
  exit 1
fi
echo -e "${GREEN}âœ… Tests passed${NC}"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
